@using Microsoft.JSInterop
@implements IAsyncDisposable
@implements IDisposable

@inject IJSRuntime JS




<h3>Recorder</h3>

<label class="label">Selezionare la telecamera</label>
<div class="field has-addons">
    <div class="control is-expanded">
         
            <div class="select is-fullwidth">
                <select id="Dispositivo" @onchange="@OnCameraSelected">

                    <option value="">Seleziona</option>
                    @foreach (var disp in _devices)
                    {
                        <option value="@disp.ID">@disp.Label</option>
                    }


                </select>
            </div>

    </div>
    <div class="control">
        <a class="button is-info" @onclick="GetDevices">
            Aggiorna
        </a>
    </div>
</div>

<div class="box">
    <video id="videoPlayer" width="320" height="320" />
</div>

@code {

    private IJSObjectReference? _JSRecorder;

    List<Device> _devices = new List<Device>();

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            _JSRecorder = await JS.InvokeAsync<IJSObjectReference>("import", "./scripts/Recorder.js");
        }
    }

    private async Task GetDevices()
    {
       
        _devices.Clear();

        await _JSRecorder.InvokeVoidAsync("ListaDevices", DotNetObjectReference.Create(this), "AggungiDevice", "EndAggiorna");

    }

    [JSInvokable]
    public void AggungiDevice(string tipo, string label, string id)
    {
        Console.WriteLine($"{tipo} {label} {id}");

        if (tipo.StartsWith("video"))
            _devices.Add(new Device { Label = $"{_devices.Count+1} {label}", ID = id });
    }

    [JSInvokable]
    public void EndAggiorna()
    {
        StateHasChanged();
    }


    private async Task OnCameraSelected(ChangeEventArgs e)
    {
        if(string.IsNullOrEmpty(e?.Value.ToString()))
        {
            return;
        }

        await _JSRecorder.InvokeVoidAsync("startVideo", "videoPlayer", e.Value);
    }


    void IDisposable.Dispose()
    {
        //_JSRecorder?.Dispose();
    }

    async ValueTask IAsyncDisposable.DisposeAsync()
    {
        if (_JSRecorder is not null)
        {
            await _JSRecorder.DisposeAsync();
        }
    }
}
